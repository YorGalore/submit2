import{openDB}from"idb";import CONFIG from"./config";const CACHE_NAME="yorgalore-v1",assetsToCache=["/","/index.html","/app.bundle.js","/app.css","/favicon.png","/manifest.json","/images/logo.png","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js","/a0c6cc1401c107b501ef.png","/8f2c4d11474275fbc161.png"],DB_NAME="yorgalore-db",STORY_OBJECT_STORE_NAME="stories",SYNC_OBJECT_STORE_NAME="offline-stories",PHOTO_OBJECT_STORE_NAME="photos",dbPromise=openDB(DB_NAME,1,{upgrade(t){t.objectStoreNames.contains("stories")||t.createObjectStore("stories",{keyPath:"id"}),t.objectStoreNames.contains("offline-stories")||t.createObjectStore("offline-stories",{keyPath:"id"}),t.objectStoreNames.contains("photos")||t.createObjectStore("photos",{keyPath:"id",autoIncrement:!0})}});async function sendOfflineStory(t){const e=await dbPromise,o=t.token,s=new FormData;let n;if(s.append("description",t.description),t.lat&&s.append("lat",t.lat),t.lon&&s.append("lon",t.lon),t.photoBlobId&&(n=await e.get("photos",t.photoBlobId)),!n)throw console.error("Photo blob missing for offline story sync:",t.id),new Error("Photo data is missing or corrupted.");s.append("photo",n,"offline-photo.png");const a=await fetch(CONFIG.BASE_URL+"/stories",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:s});if(!a.ok){const t=await a.json().catch(()=>({message:a.statusText}));throw new Error(`Failed to send offline story: ${t.message}`)}return a.json()}self.addEventListener("install",t=>{t.waitUntil(caches.open(CACHE_NAME).then(t=>t.addAll(assetsToCache)).catch(t=>console.error("Failed to cache assets:",t)))}),self.addEventListener("activate",t=>{const e=[CACHE_NAME];t.waitUntil(caches.keys().then(t=>Promise.all(t.map(t=>-1===e.indexOf(t)?caches.delete(t):Promise.resolve())))),t.waitUntil(self.clients.claim())}),self.addEventListener("fetch",t=>{const{request:e}=t,o=new URL(e.url);(o.origin===location.origin||o.origin.includes("unpkg.com")||o.origin===CONFIG.BASE_URL)&&(o.pathname.endsWith("/v1/stories")&&"GET"===e.method&&o.origin===CONFIG.BASE_URL?t.respondWith(caches.open(CACHE_NAME).then(async t=>{const o=await t.match(e),s=(async()=>{try{const o=await fetch(e);if(200===o.status){t.put(e,o.clone());const s=await o.clone().json();if(!s.error&&s.listStory){const t=(await dbPromise).transaction("stories","readwrite"),e=t.objectStore("stories");await e.clear(),s.listStory.forEach(t=>e.put(t)),await t.done}}return o}catch(o){return t.match(e)}})();return o||s.then(t=>t||dbPromise.then(async t=>{const e=await t.getAll("stories");if(e&&e.length>0){const t={error:!1,message:"Stories fetched successfully (from IDB offline)",listStory:e};return new Response(JSON.stringify(t),{headers:{"Content-Type":"application/json"},status:200})}return new Response("Network error and no local data found.",{status:404})}))})):t.respondWith(caches.match(e).then(t=>t||fetch(e))))}),self.addEventListener("push",t=>{const e=t.data.json(),{title:o,options:s}=e;s.icon="/favicon.png",s.data=s.data||{},s.actions=[{action:"view-story",title:"Lihat Cerita"}],t.waitUntil(self.registration.showNotification(o,s))}),self.addEventListener("notificationclick",t=>{const e=t.notification;e.close();const o=(e.data||{}).storyId||"",s=`#/stories/${o}`;"view-story"===t.action&&o&&t.waitUntil(self.clients.matchAll({type:"window"}).then(t=>{const e=new URL(s,self.location.origin).href;let o=t.find(t=>t.url.includes(s));o?o.focus():self.clients.openWindow(e)}))}),self.addEventListener("sync",t=>{"sync-new-story"===t.tag&&t.waitUntil(dbPromise.then(async t=>{const e=t.transaction(["offline-stories","photos"],"readwrite"),o=e.objectStore("offline-stories"),s=e.objectStore("photos"),n=(await o.getAllKeys()).map(async t=>{const e=await o.get(t);if(e)try{console.log(`Attempting to sync story ${t}`);const n=await sendOfflineStory(e);n.error?console.error(`Story ${t} failed to sync (API error): ${n.message}`):(await o.delete(t),await s.delete(e.photoBlobId),console.log(`Story ${t} successfully synced and deleted from IDB.`))}catch(e){console.error(`Story ${t} failed to sync (Network/Fetch error): ${e.message}`)}});await Promise.all(n),await e.done,self.clients.matchAll().then(t=>{t.forEach(t=>{t.postMessage({type:"StoriesSynced"})})})}).catch(t=>{console.error("Error during background sync:",t)}))});